# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release Build Matrix

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      include_ios:
        description: 'Attempt iOS build (requires signing secrets)'
        required: false
        default: 'false'
  workflow_run:
    workflows: ['Auto Release on Push']
    types: [completed]

permissions:
  contents: write

jobs:
  build-tauri:
    name: Desktop (Tauri) ${{ matrix.platform }}
    strategy:
      matrix:
        include:
          - platform: windows
            os: windows-latest
          - platform: macos
            os: macos-latest
          - platform: linux
            os: ubuntu-latest
    runs-on: ${{ matrix.os }}
    env:
      VITE_ERROR_LOG_EMAIL: 'leothefleo49@gmail.com'
      VITE_ERROR_LOG_ENDPOINT: ${{ secrets.ERROR_LOG_ENDPOINT != '' && secrets.ERROR_LOG_ENDPOINT || 'https://solar-error-reporter.railway.app/api/error-logs' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Set version from tag (tauri.conf.json + package.json + Cargo.toml)
        shell: bash
        env:
          TAG_NAME: ${{ github.event.release.tag_name != '' && github.event.release.tag_name || github.ref_name }}
        run: |
          set -e
          node -e '
            const fs = require("fs");
            const https = require("https");

            (async function() {
              try {
                let tag = (process.env.TAG_NAME || "").replace(/^v/, "");
                if (!tag) {
                  const repo = process.env.GITHUB_REPOSITORY;
                  const options = {
                    hostname: "api.github.com",
                    path: `/repos/${repo}/releases/latest`,
                    headers: { "User-Agent": "node" }
                  };
                  tag = await new Promise((resolve, reject) => {
                    https.get(options, res => {
                      let b = "";
                      res.on("data", c => b += c);
                      res.on("end", () => {
                        try { const j = JSON.parse(b); resolve((j.tag_name || "").replace(/^v/, "")); } catch (e) { reject(e); }
                      });
                    }).on("error", e => reject(e));
                  });
                }
                if (!tag) { console.error("Could not determine tag"); process.exit(1); }

                // Update tauri.conf.json
                const p1 = "App/src-tauri/tauri.conf.json";
                const j1 = JSON.parse(fs.readFileSync(p1));
                j1.version = tag;
                fs.writeFileSync(p1, JSON.stringify(j1, null, 2) + "\n");

                // Update package.json
                const p2 = "App/package.json";
                const j2 = JSON.parse(fs.readFileSync(p2));
                j2.version = tag;
                fs.writeFileSync(p2, JSON.stringify(j2, null, 2) + "\n");

                // Update Cargo.toml
                const p3 = "App/src-tauri/Cargo.toml";
                let cargo = fs.readFileSync(p3, "utf8");
                cargo = cargo.replace(/^version = ".*"$/m, `version = "${tag}"`);
                fs.writeFileSync(p3, cargo);

                console.log("✅ Set all versions to", tag);
              } catch (e) { console.error(e); process.exit(1); }
            })();
          '
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Dependencies
        run: npm ci
        working-directory: App
      
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        with:
          projectPath: App
          tagName: ${{ github.event.release.tag_name || github.ref_name }}
          releaseName: 'Solar Panel Calculator ${{ github.event.release.tag_name || github.ref_name }}'
          releaseBody: 'Automated desktop builds for Windows, macOS and Linux.'
          releaseDraft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Collect Desktop Artifacts (stable names)
        shell: bash
        run: |
          set -e
          OUT="App/src-tauri/target/release/release-artifacts"
          mkdir -p "$OUT"
          if [ "${{ matrix.platform }}" = "windows" ]; then
            MSI=$(ls App/src-tauri/target/release/bundle/msi/*.msi 2>/dev/null | head -n 1 || true)
            EXE=$(ls App/src-tauri/target/release/bundle/nsis/*.exe 2>/dev/null | head -n 1 || true)
            if [ -n "$MSI" ]; then cp "$MSI" "$OUT/Solar-Panel-Calculator-Windows.msi"; fi
            if [ -n "$EXE" ]; then cp "$EXE" "$OUT/Solar-Panel-Calculator-Windows.exe"; fi
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            DMG=$(ls App/src-tauri/target/release/bundle/dmg/*.dmg 2>/dev/null | head -n 1 || true)
            if [ -n "$DMG" ]; then cp "$DMG" "$OUT/Solar-Panel-Calculator-macOS.dmg"; fi
          else
            DEB=$(ls App/src-tauri/target/release/bundle/deb/*.deb 2>/dev/null | head -n 1 || true)
            APPIMAGE=$(ls App/src-tauri/target/release/bundle/appimage/*.AppImage 2>/dev/null | head -n 1 || true)
            if [ -n "$APPIMAGE" ]; then cp "$APPIMAGE" "$OUT/Solar-Panel-Calculator-Linux.AppImage"; fi
            if [ -n "$DEB" ]; then cp "$DEB" "$OUT/Solar-Panel-Calculator-Linux.deb"; fi
          fi

      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Solar-Panel-Calculator-Desktop-${{ matrix.platform }}
          path: App/src-tauri/target/release/release-artifacts/*

      - name: Sign Windows binaries (optional)
        if: ${{ matrix.platform == 'windows' && env.WINDOWS_PFX_BASE64 != '' }}
        shell: pwsh
        env:
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          $pfxPath = "$PWD\codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe"
          if (!(Test-Path $signtool)) { throw "signtool not found" }
          $files = Get-ChildItem "App/src-tauri/target/release/release-artifacts" -Include *.msi,*.exe -Recurse | Select-Object -ExpandProperty FullName
          foreach ($f in $files) {
            & $signtool sign /fd SHA256 /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /tr http://timestamp.digicert.com /td SHA256 $f
          }

  build-android:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: App
    env:
      VITE_ERROR_LOG_EMAIL: 'leothefleo49@gmail.com'
      VITE_ERROR_LOG_ENDPOINT: ${{ secrets.ERROR_LOG_ENDPOINT != '' && secrets.ERROR_LOG_ENDPOINT || 'https://solar-error-reporter.railway.app/api/error-logs' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'App/package-lock.json'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components (platform-tools, build-tools, platforms)
        shell: bash
        run: |
          set -e
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "platform-tools" "platforms;android-33" "build-tools;33.0.2" || true
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --list || true

      - name: Diagnostic - Java/Gradle/SDK versions
        shell: bash
        run: |
          java -version || true
          echo "JAVA_HOME=$JAVA_HOME"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          ls -la android || true
          if [ -f android/gradlew ]; then
            echo "gradlew exists, permissions:"; ls -la android/gradlew || true
          fi

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Ensure Gradle wrapper is executable
        run: |
          echo "Listing android directory before chmod"
          ls -la android || true
          chmod +x android/gradlew || true
          echo "After chmod listing"
          ls -la android || true

      - name: Normalize gradlew line endings and ensure exec
        run: |
          echo "Normalize line endings for android/gradlew and set exec"
          if [ -f android/gradlew ]; then
            sed -i 's/\r$//' android/gradlew || true
            chmod +x android/gradlew || true
            echo "gradlew permissions after normalize:"; ls -la android/gradlew || true
          else
            echo "android/gradlew not found"
          fi

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Android APK (release)
        run: |
          cd android
          ./gradlew --no-daemon --stacktrace clean :app:assembleRelease

      # Signing steps removed to avoid lint errors for undefined secrets.
      # To enable signing:
      # 1. Add secrets ANDROID_KEYSTORE_BASE64, ANDROID_KEYSTORE_PASSWORD,
      #    ANDROID_KEY_ALIAS, ANDROID_KEY_ALIAS_PASSWORD in repo settings.
      # 2. Reintroduce detect_signing, decode keystore, and signing steps.
      # 3. Optionally build a debug fallback if unsigned.

      - name: Rename APKs for release
        shell: bash
        run: |
          APK_DIR="android/app/build/outputs/apk"
          mkdir -p android/app/build/outputs/release-artifacts
          if [ -f "$APK_DIR/release/app-release-signed.apk" ]; then
            cp "$APK_DIR/release/app-release-signed.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android.apk"
          elif [ -f "$APK_DIR/release/app-release-unsigned.apk" ]; then
            cp "$APK_DIR/release/app-release-unsigned.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android-Unsigned.apk"
          fi
          if [ -f "$APK_DIR/debug/app-debug.apk" ]; then
            cp "$APK_DIR/debug/app-debug.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android-Debug.apk"
          fi

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: Solar-Panel-Calculator-Android
          path: App/android/app/build/outputs/release-artifacts/*.apk

      # Android release attachment handled in final release-attach job; remove direct release step

  build-ios:
    if: ${{ github.event.inputs.include_ios == 'true' || startsWith(github.ref, 'refs/tags/') }}
    name: iOS (Simulator Build)
    runs-on: macos-latest
    continue-on-error: true  # Don't fail CI if iOS build fails (optional platform)
    env:
      VITE_ERROR_LOG_EMAIL: 'leothefleo49@gmail.com'
      VITE_ERROR_LOG_ENDPOINT: ${{ secrets.ERROR_LOG_ENDPOINT != '' && secrets.ERROR_LOG_ENDPOINT || 'https://solar-error-reporter.railway.app/api/error-logs' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document
      - name: Install Dependencies
        run: npm ci
        working-directory: App
      - name: Add iOS Platform (Capacitor)
        run: |
          npx cap add ios || echo 'iOS platform already added'
        working-directory: App
      - name: Sync iOS
        run: npm run cap:sync:ios || echo 'iOS sync failed, continuing'
        working-directory: App
      - name: Check if iOS platform exists
        id: ios_check
        run: |
          if [ -d "ios" ]; then
            echo "ios_exists=true" >> $GITHUB_OUTPUT
          else
            echo "ios_exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ iOS platform directory not found, skipping Xcode build"
          fi
        working-directory: App
      - name: Xcode Build (Simulator, unsigned)
        if: steps.ios_check.outputs.ios_exists == 'true'
        run: |
          cd ios
          xcodebuild -scheme App -configuration Release -sdk iphonesimulator -arch x86_64 build | xcpretty || true
        working-directory: App
      - name: Package Simulator App
        if: steps.ios_check.outputs.ios_exists == 'true'
        run: |
          cd ios
          APP_PATH=$(find build -name "*.app" -type d | head -n1 || true)
          if [ -n "$APP_PATH" ]; then
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$GITHUB_WORKSPACE/Solar-Panel-Calculator-iOS-Simulator.zip"
          else
            echo "No .app found to package"
          fi
        working-directory: App
      - name: Upload iOS Simulator Artifact
        uses: actions/upload-artifact@v4
        if: ${{ hashFiles('Solar-Panel-Calculator-iOS-Simulator.zip') != '' }}
        with:
          name: Solar-Panel-Calculator-iOS-Simulator
          path: Solar-Panel-Calculator-iOS-Simulator.zip

  checksums:
    name: Generate Checksums
    needs: [build-tauri, build-android]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Generate SHA256SUMS
        run: |
          cd dist
          find . -type f \( -name "*.apk" -o -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" -o -name "*iOS-Simulator.zip" \) -exec sha256sum {} \; | sort > SHA256SUMS.txt
      - name: Upload Checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: dist/SHA256SUMS.txt

  release-attach:
    name: Attach Artifacts to Release
    needs: [build-tauri, build-android, build-ios, checksums]
    if: always() && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'release')
    runs-on: ubuntu-latest
    env:
      VITE_ERROR_LOG_EMAIL: 'leothefleo49@gmail.com'
      VITE_ERROR_LOG_ENDPOINT: ${{ secrets.ERROR_LOG_ENDPOINT != '' && secrets.ERROR_LOG_ENDPOINT || 'https://solar-error-reporter.railway.app/api/error-logs' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate Update Manifest
        run: |
          cd App
          npm install --legacy-peer-deps
          npm run generate:update-manifest
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display Artifacts
        run: ls -R artifacts
      
      - name: Copy Update Manifest to Artifacts
        run: cp App/latest.json artifacts/latest.json
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: |
            artifacts/**/*.apk
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.AppImage
            artifacts/**/*.zip
            artifacts/*.txt
            artifacts/latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-downloads:
    name: Validate Quick Download links
    needs: [release-attach]
    runs-on: ubuntu-latest
    steps:
      - name: Check latest download URLs exist
        shell: bash
        run: |
          set -e
          base="https://github.com/${GITHUB_REPOSITORY}/releases/latest/download"
          urls=(
            # Desktop (Windows)
            "$base/Solar-Panel-Calculator-Windows.msi"
            "$base/Solar-Panel-Calculator-Windows.exe"

            # macOS
            "$base/Solar-Panel-Calculator-macOS.dmg"

            # Linux
            "$base/Solar-Panel-Calculator-Linux.AppImage"
            "$base/Solar-Panel-Calculator-Linux.deb"

            # Android - try common signed/unsigned/debug names (some CI builds produce different names)
            "$base/Solar-Panel-Calculator-Android.apk"
            "$base/Solar-Panel-Calculator-Android-Unsigned.apk"
            "$base/Solar-Panel-Calculator-Android-Debug.apk"
            "$base/Solar-Panel-Calculator-Android-Release.apk"

            # iOS Simulator (optional)
            "$base/Solar-Panel-Calculator-iOS-Simulator.zip"
          )
          for u in "${urls[@]}"; do
            echo "Checking: $u"
            for i in 1 2 3; do
              code=$(curl -sSIL -o /dev/null -w "%{http_code}" "$u" || true)
              if [[ "$code" == "200" || "$code" == "302" || "$code" == "301" ]]; then
                echo "OK ($code): $u"; break
              else
                echo "Attempt $i failed ($code) for $u; retrying in 3s..."; sleep 3
              fi
              if [[ $i -eq 3 ]]; then
                echo "ERROR: $u not available (HTTP $code)"; exit 1
              fi
            done
          done
