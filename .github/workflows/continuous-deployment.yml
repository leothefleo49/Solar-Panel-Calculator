name: Continuous Deployment

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'tools/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bump-version:
    name: Bump Version & Tag
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, 'chore(release)') && github.actor != 'github-actions[bot]' }}
    outputs:
      version: ${{ steps.bump.outputs.version }}
      commit_sha: ${{ steps.get_sha.outputs.sha }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Bump Version
        id: bump
        run: |
          # Read current version
          CURRENT_VERSION=$(node -p "require('./App/package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Bump patch version
          npm version patch --no-git-tag-version --prefix App
          NEW_VERSION=$(node -p "require('./App/package.json').version")
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Sync Version to Config Files
        env:
          VERSION: ${{ steps.bump.outputs.version }}
        run: |
          node -e '
            const fs = require("fs");
            const version = process.env.VERSION;
            
            // Update tauri.conf.json
            const tauriPath = "App/src-tauri/tauri.conf.json";
            if (fs.existsSync(tauriPath)) {
              const tauriConf = JSON.parse(fs.readFileSync(tauriPath));
              tauriConf.version = version;
              fs.writeFileSync(tauriPath, JSON.stringify(tauriConf, null, 2) + "\n");
              console.log("Updated tauri.conf.json");
            }
            
            // Update Cargo.toml
            const cargoPath = "App/src-tauri/Cargo.toml";
            if (fs.existsSync(cargoPath)) {
              let cargo = fs.readFileSync(cargoPath, "utf8");
              cargo = cargo.replace(/^version = ".*"$/m, `version = "${version}"`);
              fs.writeFileSync(cargoPath, cargo);
              console.log("Updated Cargo.toml");
            }
          '

      - name: Commit & Push Changes
        run: |
          git add App/package.json App/src-tauri/tauri.conf.json App/src-tauri/Cargo.toml
          git commit -m "chore(release): bump version to ${{ steps.bump.outputs.version }} [skip ci]"
          git push origin HEAD:main

      - name: Get Commit SHA
        id: get_sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Create Tag
        run: |
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin "v${{ steps.bump.outputs.version }}"

  build-tauri:
    name: Desktop (Tauri) ${{ matrix.platform }}
    needs: bump-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
          - platform: macos
            os: macos-latest
          - platform: linux
            os: ubuntu-latest
    runs-on: ${{ matrix.os }}
    env:
      VITE_ERROR_LOG_EMAIL: 'leothefleo49@gmail.com'
      VITE_ERROR_LOG_ENDPOINT: 'https://solar-error-reporter.railway.app/api/error-logs'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.commit_sha }}
      
      - name: Configure Environment
        shell: bash
        run: |
          if [ -n "${{ secrets.ERROR_LOG_ENDPOINT }}" ]; then
            echo "VITE_ERROR_LOG_ENDPOINT=${{ secrets.ERROR_LOG_ENDPOINT }}" >> $GITHUB_ENV
          fi
      
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm ci
        working-directory: App
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Dependencies (with retries)
        shell: bash
        run: |
          set -e
          cd App
          for i in 1 2 3; do
            if npm ci --silent; then
              echo "npm ci succeeded"
              break
            else
              echo "npm ci failed, attempt $i/3"
              sleep $((i*3))
            fi
            if [ $i -eq 3 ]; then
              echo "npm ci failed after 3 attempts, trying legacy-peer-deps install"
              npm install --legacy-peer-deps || true
            fi
          done
      
      - name: Verbose Tauri Build (debug + retries)
        shell: bash
        run: |
          set -euo pipefail
          cd App
          echo "Running tauri build (will retry up to 3 times)"
          export LOGNAME="tauri-build-${{ matrix.platform }}-$(date +%s)"
          for attempt in 1 2 3; do
            echo "Attempt $attempt"
            # Run the build and capture all output to a log file for upload
            if npm run tauri:build --silent >../${LOGNAME}.log 2>&1; then
              echo "Tauri build succeeded on attempt $attempt"
              break
            else
              echo "Tauri build failed on attempt $attempt, check ../${LOGNAME}.log"
              tail -n 200 ../${LOGNAME}.log || true
              sleep $((attempt * 5))
              if [ $attempt -eq 3 ]; then
                echo "All attempts failed, exiting with failure (log saved)"
                cat ../${LOGNAME}.log || true
                exit 1
              fi
            fi
          done

      - name: Upload Tauri build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tauri-build-log-${{ matrix.platform }}
          path: |
            *.log

      - name: Collect Desktop Artifacts (stable names)
        shell: bash
        run: |
          set -e
          OUT="App/src-tauri/target/release/release-artifacts"
          mkdir -p "$OUT"
          if [ "${{ matrix.platform }}" = "windows" ]; then
            MSI=$(ls App/src-tauri/target/release/bundle/msi/*.msi 2>/dev/null | head -n 1 || true)
            EXE=$(ls App/src-tauri/target/release/bundle/nsis/*.exe 2>/dev/null | head -n 1 || true)
            if [ -n "$MSI" ]; then cp "$MSI" "$OUT/Solar-Panel-Calculator-Windows.msi"; fi
            if [ -n "$EXE" ]; then cp "$EXE" "$OUT/Solar-Panel-Calculator-Windows.exe"; fi
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            DMG=$(ls App/src-tauri/target/release/bundle/dmg/*.dmg 2>/dev/null | head -n 1 || true)
            if [ -n "$DMG" ]; then cp "$DMG" "$OUT/Solar-Panel-Calculator-macOS.dmg"; fi
          else
            DEB=$(ls App/src-tauri/target/release/bundle/deb/*.deb 2>/dev/null | head -n 1 || true)
            APPIMAGE=$(ls App/src-tauri/target/release/bundle/appimage/*.AppImage 2>/dev/null | head -n 1 || true)
            if [ -n "$APPIMAGE" ]; then cp "$APPIMAGE" "$OUT/Solar-Panel-Calculator-Linux.AppImage"; fi
            if [ -n "$DEB" ]; then cp "$DEB" "$OUT/Solar-Panel-Calculator-Linux.deb"; fi
          fi

      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Solar-Panel-Calculator-Desktop-${{ matrix.platform }}
          path: App/src-tauri/target/release/release-artifacts/*

      - name: Sign Windows binaries (optional)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        run: |
          if ([string]::IsNullOrEmpty($env:WINDOWS_PFX_BASE64)) {
            Write-Host "Skipping code signing - no certificate configured"
            exit 0
          }
          $ErrorActionPreference = 'Stop'
          $pfxPath = "$PWD\codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe"
          if (!(Test-Path $signtool)) { throw "signtool not found" }
          $files = Get-ChildItem "App/src-tauri/target/release/release-artifacts" -Include *.msi,*.exe -Recurse | Select-Object -ExpandProperty FullName
          foreach ($f in $files) {
            & $signtool sign /fd SHA256 /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /tr http://timestamp.digicert.com /td SHA256 $f
          }

  build-android:
    runs-on: ubuntu-22.04
    needs: bump-version
    defaults:
      run:
        working-directory: App
    env:
      VITE_ERROR_LOG_EMAIL: 'leothefleo49@gmail.com'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.commit_sha }}

      - name: Configure Environment
        shell: bash
        run: |
          ENDPOINT="${{ secrets.ERROR_LOG_ENDPOINT }}"
          if [ -z "$ENDPOINT" ]; then
            ENDPOINT="https://solar-error-reporter.railway.app/api/error-logs"
          fi
          echo "VITE_ERROR_LOG_ENDPOINT=$ENDPOINT" >> $GITHUB_ENV

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'App/package-lock.json'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          check-latest: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components (platform-tools, build-tools, platforms)
        shell: bash
        run: |
          set -e
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "platform-tools" "platforms;android-33" "build-tools;33.0.2" || true
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --list || true

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3
        continue-on-error: true

      - name: Ensure Gradle wrapper is executable
        run: |
          chmod +x android/gradlew || true

      - name: Normalize gradlew line endings and ensure exec
        run: |
          if [ -f android/gradlew ]; then
            sed -i 's/\r$//' android/gradlew || true
            chmod +x android/gradlew || true
          fi

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Android APK (release)
        run: |
          cd android
          ./gradlew --no-daemon --stacktrace clean :app:assembleRelease

      - name: Rename APKs for release
        shell: bash
        run: |
          APK_DIR="android/app/build/outputs/apk"
          mkdir -p android/app/build/outputs/release-artifacts
          
          # Always name the release APK consistently for the evergreen link
          # Check for universal APK first (due to splits enabled)
          if [ -f "$APK_DIR/release/app-universal-release-signed.apk" ]; then
            cp "$APK_DIR/release/app-universal-release-signed.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android.apk"
          elif [ -f "$APK_DIR/release/app-universal-release-unsigned.apk" ]; then
            cp "$APK_DIR/release/app-universal-release-unsigned.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android.apk"
          # Fallback to standard APKs
          elif [ -f "$APK_DIR/release/app-release-signed.apk" ]; then
            cp "$APK_DIR/release/app-release-signed.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android.apk"
          elif [ -f "$APK_DIR/release/app-release-unsigned.apk" ]; then
            cp "$APK_DIR/release/app-release-unsigned.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android.apk"
          fi
          
          if [ -f "$APK_DIR/debug/app-debug.apk" ]; then
            cp "$APK_DIR/debug/app-debug.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android-Debug.apk"
          fi

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: Solar-Panel-Calculator-Android
          path: App/android/app/build/outputs/release-artifacts/*.apk

  build-ios:
    if: ${{ github.event.inputs.include_ios == 'true' || startsWith(github.ref, 'refs/tags/') }}
    name: iOS (Simulator Build)
    runs-on: macos-latest
    needs: bump-version
    continue-on-error: true
    env:
      VITE_ERROR_LOG_EMAIL: 'leothefleo49@gmail.com'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.commit_sha }}
      - name: Configure Environment
        shell: bash
        run: |
          ENDPOINT="${{ secrets.ERROR_LOG_ENDPOINT }}"
          if [ -z "$ENDPOINT" ]; then
            ENDPOINT="https://solar-error-reporter.railway.app/api/error-logs"
          fi
          echo "VITE_ERROR_LOG_ENDPOINT=$ENDPOINT" >> $GITHUB_ENV
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document
      - name: Install Dependencies
        run: npm ci
        working-directory: App
      - name: Add iOS Platform (Capacitor)
        run: |
          npx cap add ios || echo 'iOS platform already added'
        working-directory: App
      - name: Sync iOS
        run: npm run cap:sync:ios || echo 'iOS sync failed, continuing'
        working-directory: App
      - name: Check if iOS platform exists
        id: ios_check
        run: |
          if [ -d "ios" ]; then
            echo "ios_exists=true" >> $GITHUB_OUTPUT
          else
            echo "ios_exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ iOS platform directory not found, skipping Xcode build"
          fi
        working-directory: App
      - name: Xcode Build (Simulator, unsigned)
        if: steps.ios_check.outputs.ios_exists == 'true'
        run: |
          cd ios
          xcodebuild -scheme App -configuration Release -sdk iphonesimulator -arch x86_64 build | xcpretty || true
        working-directory: App
      - name: Package Simulator App
        if: steps.ios_check.outputs.ios_exists == 'true'
        run: |
          cd ios
          APP_PATH=$(find build -name "*.app" -type d | head -n1 || true)
          if [ -n "$APP_PATH" ]; then
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$GITHUB_WORKSPACE/Solar-Panel-Calculator-iOS-Simulator.zip"
          else
            echo "No .app found to package"
          fi
        working-directory: App
      - name: Upload iOS Simulator Artifact
        uses: actions/upload-artifact@v4
        if: ${{ hashFiles('Solar-Panel-Calculator-iOS-Simulator.zip') != '' }}
        with:
          name: Solar-Panel-Calculator-iOS-Simulator
          path: Solar-Panel-Calculator-iOS-Simulator.zip

  checksums:
    name: Generate Checksums
    needs: [build-tauri, build-android]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Generate SHA256SUMS
        run: |
          cd dist
          find . -type f \( -name "*.apk" -o -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" -o -name "*iOS-Simulator.zip" \) -exec sha256sum {} \; | sort > SHA256SUMS.txt
      - name: Upload Checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: dist/SHA256SUMS.txt

  release-attach:
    name: Attach Artifacts to Release
    needs: [bump-version, build-tauri, build-android, build-ios, checksums]
    if: always()
    runs-on: ubuntu-latest
    env:
      VITE_ERROR_LOG_EMAIL: 'leothefleo49@gmail.com'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.commit_sha }}
      
      - name: Configure Environment
        shell: bash
        run: |
          ENDPOINT="${{ secrets.ERROR_LOG_ENDPOINT }}"
          if [ -z "$ENDPOINT" ]; then
            ENDPOINT="https://solar-error-reporter.railway.app/api/error-logs"
          fi
          echo "VITE_ERROR_LOG_ENDPOINT=$ENDPOINT" >> $GITHUB_ENV
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate Update Manifest
        run: |
          cd App
          npm install --legacy-peer-deps
          npm run generate:update-manifest
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display Artifacts
        run: ls -R artifacts
      
      - name: Copy Update Manifest to Artifacts
        run: cp App/latest.json artifacts/latest.json

      - name: Check artifacts to upload
        id: check_artifacts
        run: |
          set -e
          echo "Looking for files to attach to release..."
          FOUND=0
          # Look for common release files
          for f in artifacts/**/*.apk artifacts/**/*.msi artifacts/**/*.exe artifacts/**/*.dmg artifacts/**/*.deb artifacts/**/*.AppImage artifacts/**/*.zip artifacts/*.txt artifacts/latest.json; do
            if [ -e "$f" ]; then FOUND=1; break; fi
          done
          echo "found=$FOUND" >> $GITHUB_OUTPUT
          if [ "$FOUND" -eq 0 ]; then
            echo "No artifacts found to attach to release. Skipping release attach step.";
          else
            echo "Artifacts found to attach to release.";
          fi
      
      - name: Create GitHub Release
        if: steps.check_artifacts.outputs.found == '1'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ needs.bump-version.outputs.version }}"
          name: "v${{ needs.bump-version.outputs.version }}"
          body: "Automated release for version ${{ needs.bump-version.outputs.version }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true
          files: |
            artifacts/**/*.apk
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.AppImage
            artifacts/**/*.zip
            artifacts/*.txt
            artifacts/latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-downloads:
    name: Validate Quick Download links
    needs: [release-attach]
    runs-on: ubuntu-latest
    steps:
      - name: Check latest download URLs exist
        shell: bash
        run: |
          set -e
          base="https://github.com/${GITHUB_REPOSITORY}/releases/latest/download"
          urls=(
            # Desktop (Windows)
            "$base/Solar-Panel-Calculator-Windows.msi"
            "$base/Solar-Panel-Calculator-Windows.exe"

            # macOS
            "$base/Solar-Panel-Calculator-macOS.dmg"

            # Linux
            "$base/Solar-Panel-Calculator-Linux.AppImage"
            "$base/Solar-Panel-Calculator-Linux.deb"

            # Android - try common signed/unsigned/debug names (some CI builds produce different names)
            "$base/Solar-Panel-Calculator-Android.apk"
            "$base/Solar-Panel-Calculator-Android-Debug.apk"

            # iOS Simulator (optional)
            "$base/Solar-Panel-Calculator-iOS-Simulator.zip"
          )
          for u in "${urls[@]}"; do
            echo "Checking: $u"
            for i in 1 2 3; do
              code=$(curl -sSIL -o /dev/null -w "%{http_code}" "$u" || true)
              if [[ "$code" == "200" || "$code" == "302" || "$code" == "301" ]]; then
                echo "OK ($code): $u"; break
              else
                echo "Attempt $i failed ($code) for $u; retrying in 3s..."; sleep 3
              fi
              if [[ $i -eq 3 ]]; then
                echo "ERROR: $u not available (HTTP $code)"; exit 1
              fi
            done
          done
