stages:
  - build
  - release

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# Desktop builds (Tauri)
build:windows:
  stage: build
  tags:
    - windows
    - shell
  before_script:
    - choco install nodejs-lts -y
    - choco install rust -y
    - refreshenv
  script:
    - cd App
    - npm ci
    - npm run tauri build
  artifacts:
    paths:
      - App/src-tauri/target/release/bundle/msi/*.msi
      - App/src-tauri/target/release/bundle/nsis/*.exe
    expire_in: 1 week
  only:
    - tags
    - main

build:macos:
  stage: build
  tags:
    - macos
  before_script:
    - brew install node
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
  script:
    - cd App
    - npm ci
    - npm run tauri build
  artifacts:
    paths:
      - App/src-tauri/target/release/bundle/dmg/*.dmg
      - App/src-tauri/target/release/bundle/macos/*.app
    expire_in: 1 week
  only:
    - tags
    - main

build:linux:
  stage: build
  image: ubuntu:22.04
  before_script:
    - apt-get update
    - apt-get install -y curl wget build-essential libssl-dev pkg-config
    - apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
  script:
    - cd App
    - npm ci
    - npm run tauri build
  artifacts:
    paths:
      - App/src-tauri/target/release/bundle/deb/*.deb
      - App/src-tauri/target/release/bundle/appimage/*.AppImage
    expire_in: 1 week
  only:
    - tags
    - main

# Android build
build:android:
  stage: build
  image: cimg/android:2024.01.1-node
  before_script:
    - sudo apt-get update
    - sudo apt-get install -y openjdk-17-jdk
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    - export PATH=$JAVA_HOME/bin:$PATH
  script:
    - cd App
    - npm ci
    - npm run build
    - npx cap sync android
    - cd android
    - chmod +x gradlew
    - ./gradlew --no-daemon --stacktrace clean assembleRelease
    - mkdir -p ../build-output
    - |
      if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
        cp app/build/outputs/apk/release/app-release-unsigned.apk ../build-output/Solar-Panel-Calculator-Android.apk
      fi
  artifacts:
    paths:
      - App/build-output/*.apk
    expire_in: 1 week
  only:
    - tags
    - main

# Checksums
checksums:
  stage: build
  image: alpine:latest
  needs:
    - build:linux
    - build:android
  before_script:
    - apk add --no-cache coreutils
  script:
    - |
      cd App
      find . -name "*.apk" -o -name "*.deb" -o -name "*.AppImage" | while read file; do
        sha256sum "$file" >> SHA256SUMS.txt
      done
  artifacts:
    paths:
      - App/SHA256SUMS.txt
    expire_in: 1 week
  only:
    - tags
    - main

# Release packaging
release:
  stage: release
  image: alpine:latest
  needs:
    - build:linux
    - build:android
    - checksums
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "All artifacts ready for release"
    - ls -R App/
  artifacts:
    paths:
      - App/build-output/
      - App/src-tauri/target/release/bundle/
      - App/SHA256SUMS.txt
    expire_in: 1 month
  only:
    - tags
