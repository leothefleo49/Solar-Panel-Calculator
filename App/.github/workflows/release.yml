name: Release Desktop & Mobile Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
          - platform: 'ubuntu-22.04'
            args: '--target x86_64-unknown-linux-gnu'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'

    runs-on: ${{ matrix.platform }}
    defaults:
      run:
        working-directory: App
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'App/package-lock.json'

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || matrix.platform == 'windows-latest' && 'x86_64-pc-windows-msvc' || 'x86_64-unknown-linux-gnu' }}

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install frontend dependencies
        run: npm install --legacy-peer-deps

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: App
          tagName: ${{ github.ref_name }}
          releaseName: 'Solar Panel Calculator ${{ github.ref_name }}'
          releaseBody: 'See INSTALLATION.md for platform-specific installation instructions.'
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

  release-android:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: App
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'App/package-lock.json'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components (platform-tools, build-tools, platforms)
        shell: bash
        run: |
          set -e
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "platform-tools" "platforms;android-33" "build-tools;33.0.2" || true
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --list || true

      - name: Diagnostic: Java/Gradle/SDK versions
        shell: bash
        run: |
          java -version || true
          echo "JAVA_HOME=$JAVA_HOME"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          ls -la android || true
          if [ -f android/gradlew ]; then
            echo "gradlew exists, permissions:"; ls -la android/gradlew || true
          fi

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Ensure Gradle wrapper is executable
        run: |
          echo "Listing android directory before chmod"
          ls -la android || true
          chmod +x android/gradlew || true
          echo "After chmod listing"
          ls -la android || true

      - name: Normalize gradlew line endings and ensure exec
        run: |
          echo "Normalize line endings for android/gradlew and set exec"
          if [ -f android/gradlew ]; then
            sed -i 's/\r$//' android/gradlew || true
            chmod +x android/gradlew || true
            echo "gradlew permissions after normalize:"; ls -la android/gradlew || true
          else
            echo "android/gradlew not found"
          fi

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Android APK (release)
        working-directory: android
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_21_X64 }}
        run: ./gradlew --no-daemon --stacktrace clean :app:assembleRelease

      - name: Detect signing secrets
        id: detect_signing
        shell: bash
        env:
          KS_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KS_PW: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ALIAS_PW: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          if [[ -n "${KS_B64}" && -n "${KS_PW}" && -n "${ALIAS}" && -n "${ALIAS_PW}" ]]; then
            echo "has_signing=true" >> $GITHUB_OUTPUT
          else
            echo "has_signing=false" >> $GITHUB_OUTPUT
          fi

      - name: Decode keystore
        if: steps.detect_signing.outputs.has_signing == 'true'
        shell: bash
        env:
          KS_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "Decoding Android keystore"
          mkdir -p android/app/keystore
          echo "${KS_B64}" | base64 -d > android/app/keystore/release.keystore

      - name: Zipalign and Sign APK
        if: steps.detect_signing.outputs.has_signing == 'true'
        shell: bash
        run: |
          set -euo pipefail
          APK_DIR="android/app/build/outputs/apk/release"
          UNSIGNED_APK="$APK_DIR/app-release-unsigned.apk"
          ALIGNED_APK="$APK_DIR/app-release-aligned.apk"
          SIGNED_APK="$APK_DIR/app-release-signed.apk"

          # Find latest build-tools
          BT_DIR=$(ls -d "$ANDROID_SDK_ROOT"/build-tools/* | sort -V | tail -n1)
          echo "Using build-tools in $BT_DIR"

          "$BT_DIR/zipalign" -f -v 4 "$UNSIGNED_APK" "$ALIGNED_APK"
          "$BT_DIR/apksigner" sign \
            --ks android/app/keystore/release.keystore \
            --ks-key-alias "${ALIAS}" \
            --ks-pass env:KS_PASS \
            --key-pass env:KEY_PASS \
            --out "$SIGNED_APK" \
            "$ALIGNED_APK"
        env:
          KS_PASS: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASS: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
          ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

      - name: Build Android APK (debug fallback)
        if: steps.detect_signing.outputs.has_signing != 'true'
        working-directory: android
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_21_X64 }}
        run: ./gradlew --no-daemon --stacktrace :app:assembleDebug

      - name: Rename APKs for release
        shell: bash
        run: |
          APK_DIR="android/app/build/outputs/apk"
          mkdir -p android/app/build/outputs/release-artifacts
          if [ -f "$APK_DIR/release/app-release-signed.apk" ]; then
            cp "$APK_DIR/release/app-release-signed.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android.apk"
          elif [ -f "$APK_DIR/release/app-release-unsigned.apk" ]; then
            cp "$APK_DIR/release/app-release-unsigned.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android-Unsigned.apk"
          fi
          if [ -f "$APK_DIR/debug/app-debug.apk" ]; then
            cp "$APK_DIR/debug/app-debug.apk" "android/app/build/outputs/release-artifacts/Solar-Panel-Calculator-Android-Debug.apk"
          fi

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: Solar-Panel-Calculator-Android
          path: App/android/app/build/outputs/release-artifacts/*.apk

      - name: Create Release (Android)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: App/android/app/build/outputs/release-artifacts/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-ios:
    runs-on: macos-latest
    defaults:
      run:
        working-directory: App
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'App/package-lock.json'

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Install CocoaPods dependencies
        working-directory: ios/App
        run: pod install

      - name: Build iOS App
        working-directory: ios/App
        run: |
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath $PWD/build/App.xcarchive \
            archive

      - name: Export IPA
        working-directory: ios/App
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/App.xcarchive \
            -exportPath $PWD/build \
            -exportOptionsPlist exportOptions.plist

      - name: Create exportOptions.plist
        working-directory: ios/App
        run: |
          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>teamID</key>
              <string>YOUR_TEAM_ID</string>
          </dict>
          </plist>
          EOF

      - name: Upload iOS IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: App/ios/App/build/App.ipa

      - name: Create Release (iOS)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: App/ios/App/build/App.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
